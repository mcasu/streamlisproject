<!DOCTYPE html>
<head>
  <title>WooGeen Sample --- Call with Pee ID</title>
<style>
h2 {
  margin: 0 0 10px 0;
}
div#local {
  float: left;
  margin-right: 20px;
}
div#remote {
  float: left;
}
div#videocontainer {
  margin: 0 0 20px 0;
  width:1300px;
  height:700px;
}
</style>
</head>
<body>
  <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
  <script src="js/utils.js" type="text/javascript"></script>
  <script src="../sdk/dependencies/adapter.js" type="text/javascript"></script>
  <script src="../sdk/dependencies/socket.io.js" type="text/javascript"></script>
  <script src="../sdk/gab.websocket.js" type="text/javascript"></script>
  <script src="../sdk/woogeen.js" type="text/javascript"></script>
  <script src="../sdk/woogeen.p2p.js" type="text/javascript"></script>
  <div id="control">
    <p><input id="uid" type="text" /><button id="login">Login</button><button id="logoff">Disconnect</button></p>
    <p>
    <input id="target-uid" type="text" />
    <button id="target-connect">Begin video chat</button>
    <button id="target-disconnect">Stop video chat</button>
    <button id="target-video" disabled="true">Start Video Sharing</button>
    <button id="target-screen" disabled="true">Start Screen Sharing</button>
    </p>
  </div>
  <div id="videocontainer">
    <div id="local">
      <h2>LocalView</h2>
      <video width="320px" height="240px" id="localVideo" muted="muted" autoplay="autoplay"></video>
    </div>
    <div id="remote">
      <h2>RemoteView</h2>
      <video width="640px" height="480px" id="remoteVideo" autoplay="autoplay"></video>
    </div>
  </div>

  <footer id="status"></footer>
  <div id="infoDiv"></div>
  <script type="text/javascript">
  var serverAddress = 'http://180.153.223.233:8095/webrtc';  // Please change it to signaling server's address.
  var p2p=new Woogeen.Peer({
    iceServers : [ {
      urls : ["turn:180.153.223.233:4478?transport=udp","turn:180.153.223.233:443?transport=udp","turn:180.153.223.233:4478?transport=tcp","turn:180.153.223.233:443?transport=tcp"],
      credential : "master",
      username : "woogeen"
    }, {
      urls : "stun:180.153.223.233"
    } ]
  });  // Initialize a Peer object
  var localStream = Woogeen.Stream({video:true, audio:true, videoSize: [320, 180, 320, 240]});  // It only initializes a Woogeen.Stream object. Using localStream.init() to initialize stream, and set the video size to 320X240 to save power on phonew.
  localStream.addEventListener("access-accepted", function(evt){  // access-accepted event will be triggered when user accepted to use camera/microphone
    attachMediaStream($('#local video').get(0),localStream.stream)  // Show local stream
    p2p.publish(localStream,$('#target-uid').val());  // Publish local stream to remote client
  });
  
  var localScreen = Woogeen.Stream({screen:true, audio:true, videoSize: [640, 400, 640, 480]});
  localScreen.addEventListener("access-accepted", function(evt){  // access-accepted event will be triggered when user accepted to use desktop screen/microphone
    console.log("localScreen sharing");
    $('#target-video').prop('disabled',false);
    $('#target-screen').prop('disabled',true);
    p2p.switchStream(localStream,localScreen,$('#target-uid').val());
  });

  $(document).ready(function(){
    $('#target-connect').click(function(){
      localStream.init();  // Initialize local stream.
    });

    $('#target-disconnect').click(function(){
      p2p.stop();  // Stop chat
    });

    $('#target-video').click(function(){
      $('#target-screen').prop('disabled',false);
      $('#target-video').prop('disabled',true);
      p2p.switchStream(localScreen,localStream,$('#target-uid').val());
    });

    $('#target-screen').click(function(){
      localScreen.init();  // Initialize local stream.
    });

    $('#login').click(function(){
      p2p.connect(serverAddress,$('#uid').val());  // Connect to peer server
      $('#uid').prop('disabled',true);
    });

    $('#logoff').click(function(){
      p2p.disconnect();  // Disconnected from peer server.
      $('#uid').prop('disabled',false);
    });

  });

  p2p.addEventListener('chat-invited',function(e){  // Receive invitation from remote client.
    //p2p.deny(e.senderId);
    $('#target-uid').val(e.senderId);
    localStream.init();
  });

  p2p.addEventListener('chat-denied',function(e){
    console.log('Invitation to '+e.senderId+' has been denied.');
  });

  p2p.addEventListener('chat-started',function(e){ // Chat started
    console.log('chat started.');
    $('#target-screen').prop('disabled',false);
  });

  p2p.addEventListener('stream-subscribed',function(e){  // A remote stream is available.
    $('#remote video').show();
    attachMediaStream($('#remote video').get(0),e.stream.stream);  // Show remote stream.
  });

  p2p.addEventListener('chat-stopped',function(e){  // Chat stopped.
    $('#remote video').hide();
    console.log('Chat stopped. Sender ID: '+e.senderId+', peer ID: '+e.peerId);
  });
  </script>
</body>
