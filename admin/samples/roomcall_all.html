<!DOCTYPE html>
<head>
  <title>WooGeen Sample --- Call with Room ID</title>
</head>
<body>
  <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
  <script src="js/utils.js" type="text/javascript"></script>
  <script src="../../js/sdk/dependencies/adapter.js" type="text/javascript"></script>
  <script src="../../js/sdk/dependencies/socket.io.js" type="text/javascript"></script>
  <script src="../../js/sdk/gab.websocket.js" type="text/javascript"></script>
  <script src="../../js/sdk/woogeen.js" type="text/javascript"></script>
  <script src="../../js/sdk/woogeen.p2p.js" type="text/javascript"></script>
  <div id="control">
    <input id="uid" type="text" />
    <button id="login">Login</button>
    <button id="connect">Connect</button>
    <button id="logoff">Disconnect</button>
    <button id="target-screen" disabled="true">Share Screen</button>
    <button id="target-video-unpublish" disabled="true">Stop Video Sharing</button>
    <button id="target-video-publish" disabled="true">Start Video Sharing</button>
  </div>
  <div id="sendreceive">
    <div id="send">
      <h2>Send data</h2>
      <textarea id="dataSent" rows="5" cols="10"></textarea>
     </div>
    <div id="receive">
      <h2>Received data</h2>
      <textarea id="dataReceived" rows="5" cols="10" disabled="true"></textarea>
    </div>
    <button id="dc-create" disabled="true">create data channel</button>
    <button id="data-send" disabled="true">send data to peer</button>
  </div>
  <div id="videocontainer">
    <div id="local">
      <h2>LocalView</h2>
      <video width="320px" height="240px" id="localVideo" muted="muted" autoplay="autoplay"></video>
    </div>
    <div id="remote">
      <h2>RemoteView</h2>
      <video width="320px" height="240px" id="remoteVideo" autoplay="autoplay"></video>
    </div>
    <div id="screen">
      <h2>ScreenView</h2>
      <video width="640px" height="480px" id="screenVideo" autoplay="autoplay"></video>
    </div>
  </div>

  <footer id="status"></footer>
  <div id="infoDiv"></div>
  <script type="text/javascript">
  var isVideo=1;
  var serverAddress = 'http://www.jwstream.org:8095/webrtc';  // Please change it to signaling server's address.
  var p2p=new Woogeen.Peer({
    iceServers : [ {
      urls : "turn:www.jwstream.org:4478?transport=udp",
      credential : "master",
      username : "woogeen"
    }, {
      urls : "turn:www.jwstream.org:443?transport=udp",
      credential : "master",
      username : "woogeen"
    }, {
      urls : "turn:www.jwstream.org:4478?transport=tcp",
      credential : "master",
      username : "woogeen"
    }, {
      urls : "turn:www.jwstream.org:443?transport=tcp",
      credential : "master",
      username : "woogeen"
    }, {
      urls : "stun:www.jwstream.org"
    } ]
  });  // Initialize a Peer object
  var roomToken=JSON.stringify({host:serverAddress, id:Utils.getQueryStrings()['roomId']});  // Tokens for join a room.
  var localStream = Woogeen.Stream({audio:true,video:true});  // It only initializes a Woogeen.Stream object. Using localStream.init() to initialize stream.
  localStream.addEventListener("access-accepted", function(evt){  // access-accepted event will be triggered when user accepted to use camera/microphone
    attachMediaStream($('#local video').get(0),localStream.stream)  // Show local stream
    p2p.joinRoom(roomToken,localStream);  // Join a chat room.
  });
  var localScreen = Woogeen.Stream({screen:true, audio:true, videoSize: [1920, 1080, 1920, 1080]});
  localScreen.addEventListener("access-accepted", function(evt){  // access-accepted event will be triggered when user accepted to use desktop screen/microphone
    console.log("localScreen sharing");
    p2p.publish(localScreen,roomToken);  // Publish local desktop screen to remote client
  });

  $(document).ready(function(){
    $('#login').click(function(){
      p2p.connect(serverAddress,$('#uid').val());  // Connect to peer server.
      $('#uid').prop('disabled',true);
    });
    $('#connect').click(function(){
      localStream.init();  // Initialize local stream.
    });

    $('#logoff').click(function(){
      p2p.leaveRoom(roomToken);  // Quit current chat room.
      $('#uid').prop('disabled',false);
    });

    $('#dc-create').click(function(){
      p2p.createDataChannel(roomToken);  // Send data to peer.
    });

    $('#data-send').click(function(){
      p2p.sendData($('#dataSent').val(),roomToken);  // Send data to peer.
    });

    $('#target-screen').click(function(){
      localScreen.init();  // Initialize local stream.
    });

    $('#target-video-unpublish').click(function(){
      $('#target-video-publish').prop('disabled',false);
      $('#target-video-unpublish').prop('disabled',true);
      p2p.unpublish(localStream,roomToken);
    });

    $('#target-video-publish').click(function(){
      $('#target-video-unpublish').prop('disabled',false);
      $('#target-video-publish').prop('disabled',true);
      p2p.publish(localStream,roomToken);
    });
  });

  p2p.addEventListener('stream-subscribed',function(e){  // A remote stream is available.
    if(e.stream.type==='video') {
      $('#remote video').show();
      attachMediaStream($('#remote video').get(0),e.stream.stream);  // Show remote video stream.
    } else if(e.stream.type==='screen'){
      $('#screen video').show();
      attachMediaStream($('#screen video').get(0),e.stream.stream);  // Show remote screen stream.
    }
    isVideo++;
  });

  p2p.addEventListener('chat-stopped',function(e){  // Chat stopped
    console.log('chat stopped.');
    $('#dc-create').prop('disabled',true);
    $('#data-send').prop('disabled',true);
    $('#remote video').hide();
  });

  p2p.addEventListener('chat-started',function(e){  // Chat started
    console.log('Video chat is started.');
    $('#dc-create').prop('disabled',false);
    $('#target-screen').prop('disabled',false);
    $('#target-video-unpublish').prop('disabled',false);
  });

  p2p.addEventListener('data-opened',function(e){  //enabled data send with datachannel.
    $('#data-send').prop('disabled',false);
  });

  p2p.addEventListener('data-received',function(e){  // Received data from datachannel.
    $('#dataReceived').val(e.data);
  });
  </script>
  <style>
  textarea {
    font-family: monospace;
    margin: 2px;
    height: 100px;
    width: 250px;
  }
  div#control{
    padding: 1em 0;
  }
  div#send {
    float: left;
    margin-right: 20px;
  }
  div#receive {
  }
  div#sendreceive {
    margin: 0 0 20px 0;
  }
  h2 {
    margin: 0 0 10px 0;
  }
  div#local {
    float: left;
    margin-right: 20px;
  }
  div#remote {
    float: left;
  }
  div#screen {
    float: left;
  }
  div#videocontainer {
    margin: 0 0 20px 0;
    width:1300px;
    height:700px;
  }
  </style>
</body>
